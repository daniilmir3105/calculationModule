# Требования к скриптам расчетов для системы Indanis

Этот документ описывает требования к структуре проекта и работе скриптов для системы Indanis.

## Структура zip-архива для расчета

Zip-архив должен иметь следующую структуру:

```plaintext
archive.zip/  
├── main.py          # Файл запуска скрипта  
├── requirements.txt # Список зависимостей для установки через pip  
└── ...              # Прочие файлы проекта
```

### Требования к файлам:

1. **`main.py`**:
   - Основной файл, который содержит логику выполнения скрипта.
   - Должен быть исполняемым и находиться в корне zip-архива.
2. **`requirements.txt`**:
   - Файл должен содержать список зависимостей, которые будут установлены через `pip`.
   - Должен находиться в корне zip-архива.
   - Если дополнительные пакеты не требуются, файл должен быть пустым, но все равно присутствовать.

## Требования к работе скрипта

### 1\. **Кроссплатформенность**

- Скрипт должен быть кроссплатформенным и не содержать платформо-зависимого кода.
- Скрипт должен корректно работать на различных операционных системах (Windows, Linux).

### 2\. **Независимость от версии Python**

- Скрипт не должен использовать код, который привязан к конкретной версии интерпретатора Python.
- Код должен быть совместим с актуальными версиями Python 3.x.

### 3\. **Считывание параметров расчета**

- Скрипт должен считывать значения параметров из файла `inputParameters.json`, расположенного в папке `inputs`.
- Значения параметров типов `Date` и `Timestamp` сохраняются в формате `Long` (количество миллисекунд от 1 января 1970 года).

Пример структуры файла:

```json
{
    "solver":"2356c206-2958-4e9d-b610-3c7dfa02cd28",
    "timeout":0,
    "contents":["7ad5f615-4d04-4f20-a740-ccaf40a5d8a0"],
    "dashboard":null,
    "String":"ola",
    "Boolean":true,
    "Date":1767214800000,
    "Double":3.14,
    "Integer":123,
    "Timestamp":1767214800000,
    "UUID":"66666666-6666-6666-6666-666666666666"
}
```

### 4\. **Считывание входных данных**

- Скрипт должен считывать входные данные из директории `inputs`.
- В зависимости от _ваших потребностей_ и _необходимости во вложенной структуре_ входные данные могут быть организованы в папке `inputs` двумя способами:
  - **Плоская структура** - все файлы размещаются непосредственно в папке `inputs` без сохранения исходной иерархии.
  - **Иерархическая структура** - файлы копируются с сохранением папок и подпапок, соответствующих структуре, заданной в интерфейсе.

  Данная возможность конфигурируется через интерфейс при создании расчета. Необходимо учитывать этот момент при реализации расчетного модуля.

К примеру, расчет осуществляется по статистике (например, рождаемость и смертность), собранной по федеральным округам и регионам в них. Пользователь через интерфейс платформы Indanis загружает папки с ФО и регионами, в которых расположены файлы `birth.csv` и `death.csv`. Затем при создании расчета он выбирает сохранять структуру входных данных.

Тогда структура папки `inputs`будет следующая:

```plaintext
inputs/  
├── ЦФО/                     # Папка для ФО  
│   ├── Московская область/  # Папка для региона
│   │   ├── birth.csv
│   │   ├── death.csv
│   ├── Курская область/
│   │   ├── birth.csv
│   │   ├── death.csv
├── СЗФО/
│   ├── ...
└──...
```

В противном случае, если выбрать выгрузку входных данных без сохранения структуры, в папке `inputs` будет лежать всего лишь три файла - `birth.csv` , `death.csv` и `inputParameters.json`, так как файлы с одинаковыми названиями в файловой системе перезаписывают друг друга.

### 5\. **Оповещение о прогрессе**

- Скрипт должен оповещать о прогрессе выполнения через вывод текстового сообщения в `stdout` или `stderr`.
- Сообщение должно быть в формате: `<PROGRESS: N %>`, где `N` — неотрицательное целое число от 0 до 100.
- Значения `N > 100` игнорируются.
- Для своевременной обработки сообщения необходимо очищать буфер вывода (использовать `flush=True`).

Пример функции оповещения прогресса:

```python
def reportProgress(perc):
    print(f"<PROGRESS: {int(perc)} %>", flush=True)
```

### 6\. **Сохранение результатов**

- Результаты работы скрипта должны сохраняться в папку `results`, которая должна находиться на том же уровне, что и `main.py`.
- Скрипт должен самостоятельно создавать папку `results`, если она отсутствует.

Пример структуры проекта после работы скрипта:

```plaintext
project/  
├── main.py  
├── requirements.txt  
├── results/       # Папка с результатами, созданная скриптом  
│   ├── output.txt # Пример файла с результатами  
│   └── ...        # Прочие файлы результатов
└── ...            # Прочие файлы проекта
```
